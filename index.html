<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Android Security Assistant</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body{margin:0;font-family:Arial;background:#0a0f23;color:#fff}
header{padding:15px;text-align:center;font-size:18px;background:#020617}
.container{padding:12px}
button,input,textarea{width:100%;padding:12px;margin-top:8px;border-radius:8px;border:none;font-size:15px}
button{background:#22c55e;color:#000;font-weight:bold}
.card{border:1px solid #1e293b;border-radius:10px;padding:12px;margin-top:12px}
.log{background:#000;padding:10px;border-radius:6px;min-height:60px;overflow-wrap:break-word;}
video,canvas{width:100%;border-radius:10px;margin-top:10px;}
#map{height:250px;border-radius:10px;margin-top:10px;}
</style>
</head>
<body>

<header>üéô Android Security Assistant</header>

<div class="container">
<button id="startBtn">‚ñ∂ Start Assistant</button>

<div class="card">
<b>Heard</b>
<div id="heard" class="log">Waiting‚Ä¶</div>
</div>

<div class="card">
<b>Response</b>
<div id="response" class="log">---</div>
</div>

<div class="card">
<b>üìç Location</b>
<div id="loc" class="log">Inactive</div>
<div id="map"></div>
</div>

<div class="card">
<b>üé• Camera Feed</b>
<video id="cam" autoplay playsinline muted></video>
<canvas id="overlay"></canvas>
</div>
</div>

<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ==== GLOBALS ==== */
let rec, voiceActive=false;
let camStream=null, watchId=null;
let dictation=false, trustedFacePresent=false;
const heardEl=document.getElementById("heard");
const responseEl=document.getElementById("response");
const locEl=document.getElementById("loc");
const cam=document.getElementById("cam");
const overlay=document.getElementById("overlay");
let map, marker;

/* ==== UTILITY FUNCTIONS ==== */
function speak(text){
  speechSynthesis.cancel();
  let u=new SpeechSynthesisUtterance(text);
  u.lang=navigator.language||"en-US";
  speechSynthesis.speak(u);
  responseEl.innerText=text;
}

function savePhoto(blob){
  const link=document.createElement("a");
  link.href=URL.createObjectURL(blob);
  link.download=`emergency_${Date.now()}.png`;
  link.click();
  speak("Emergency photo saved");
}

/* ==== CAMERA CONTROL ==== */
async function openCamera(){
  if(camStream) return;
  try{
    camStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});
    cam.srcObject = camStream;
    overlay.width=cam.videoWidth;
    overlay.height=cam.videoHeight;
    detectFacesLoop();
    speak("Camera on");
  }catch(e){speak("Camera permission denied");}
}

function closeCamera(){
  if(!camStream) return;
  camStream.getTracks().forEach(t=>t.stop());
  camStream=null;
  speak("Camera off");
}

/* ==== GPS & MAP ==== */
function initMap(lat,lng){
  map=L.map('map').setView([lat,lng],15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);
  marker=L.marker([lat,lng]).addTo(map);
}

function updateLocation(position){
  const lat=position.coords.latitude;
  const lng=position.coords.longitude;
  locEl.innerHTML=`Lat: ${lat}<br>Lng: ${lng}<br>Accuracy: ${position.coords.accuracy} m`;
  if(marker){marker.setLatLng([lat,lng]); map.setView([lat,lng]);}
}

function startTracking(){
  if(!navigator.geolocation){speak("Geolocation not supported"); return;}
  watchId=navigator.geolocation.watchPosition(updateLocation,()=>{
    speak("Location error");
  },{enableHighAccuracy:true});
  speak("Tracking started");
}

function stopTracking(){
  if(watchId){navigator.geolocation.clearWatch(watchId); watchId=null;}
  speak("Tracking stopped");
}

/* ==== EMERGENCY PHOTO ==== */
function takeEmergencyPhoto(){
  if(!camStream){speak("Camera not active"); return;}
  const snap=document.createElement("canvas");
  snap.width=cam.videoWidth; snap.height=cam.videoHeight;
  snap.getContext("2d").drawImage(cam,0,0,snap.width,snap.height);
  snap.toBlob(savePhoto);
}

/* ==== FACE RECOGNITION ==== */
let labeledFaceDescriptors=null;

async function loadFaceModels(){
  const MODEL_PATH='https://justadudewhohacks.github.io/face-api.js/models';
  await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_PATH);
  await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_PATH);
  await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_PATH);
  speak("Face models loaded");
  // TODO: Add your trusted labeled descriptors here
  // Example:
  // labeledFaceDescriptors = [
  //   new faceapi.LabeledFaceDescriptors("YourName", [descriptorArray])
  // ];
}

function detectFacesLoop(){
  if(!camStream) return;
  const displaySize={width:cam.videoWidth,height:cam.videoHeight};
  faceapi.matchDimensions(overlay, displaySize);

  setInterval(async ()=>{
    const detections=await faceapi.detectAllFaces(cam,new faceapi.TinyFaceDetectorOptions())
      .withFaceLandmarks().withFaceDescriptors();
    const ctx=overlay.getContext("2d");
    ctx.clearRect(0,0,overlay.width,overlay.height);

    if(detections.length>0){
      const resized=faceapi.resizeResults(detections,displaySize);
      faceapi.draw.drawDetections(overlay,resized);
      faceapi.draw.drawFaceLandmarks(overlay,resized);
      trustedFacePresent=true; // for demo; use matcher below when labels added
    } else {trustedFacePresent=false;}
  },300);
}

/* ==== VOICE COMMANDS ==== */
function handleCommand(cmd){
  heardEl.innerText=cmd;

  if(!trustedFacePresent){
    speak("No trusted face detected ‚Äî commands blocked.");
    return;
  }

  cmd=cmd.toLowerCase();
  if(cmd.includes("emergency")){
    takeEmergencyPhoto();
    return;
  }

  const acts={
    "start camera": openCamera,
    "stop camera": closeCamera,
    "start tracking": startTracking,
    "stop tracking": stopTracking,
    "what time": ()=>speak("Time is "+new Date().toLocaleTimeString()),
    "what date": ()=>speak("Date is "+new Date().toDateString()),
    "battery status": ()=>{
      navigator.getBattery().then(b=>{
        speak("Battery at "+Math.round(b.level*100)+" percent");
      });
    },
    "screenshot": ()=>{
      html2canvas(document.body).then(canvas=>{
        canvas.toBlob(savePhoto);
      });
    }
  };

  for(let k in acts){
    if(cmd.includes(k)){ acts[k](); return; }
  }
  speak("Command not recognized");
}

function startVoiceRecognition(){
  if(voiceActive) return;
  rec=new (window.SpeechRecognition||window.webkitSpeechRecognition)();
  rec.continuous=true;
  rec.interimResults=false;
  rec.lang=navigator.language||"en-US";

  rec.onresult=e=>{
    const spoken=e.results[e.results.length-1][0].transcript;
    handleCommand(spoken);
  };
  rec.onerror=()=>speak("Voice recognition error");
  rec.start();
  voiceActive=true;
  speak("Voice assistant activated. Face must remain visible.");
}

/* ==== START BUTTON ==== */
document.getElementById("startBtn").addEventListener("click", async ()=>{
  try{await navigator.mediaDevices.getUserMedia({audio:true,video:true});}
  catch{ speak("Camera/Mic permission needed"); return; }

  startVoiceRecognition();
  await loadFaceModels();
  openCamera();
  navigator.geolocation.getCurrentPosition(pos=>{
    initMap(pos.coords.latitude,pos.coords.longitude);
  });
});
</script>

</body>
</html>
