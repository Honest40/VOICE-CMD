<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Android Security Assistant</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
body{margin:0;font-family:Arial;background:#020617;color:#fff}
header{padding:15px;text-align:center;font-size:18px;border-bottom:1px solid #1e293b}
.container{padding:10px}
button,input,textarea{width:100%;padding:12px;margin-top:8px;border-radius:8px;border:none;font-size:15px}
button{background:#22c55e;color:#000;font-weight:bold}
.card{border:1px solid #1e293b;border-radius:10px;padding:12px;margin-top:12px}
.log{background:#000;padding:10px;border-radius:6px;min-height:60px;overflow-wrap: break-word;}
video,canvas{width:100%;border-radius:10px;margin-top:10px;}
#map{height:250px;border-radius:10px;margin-top:10px;}
</style>
</head>
<body>

<header>üéô Android Security Assistant</header>

<div class="container">
<button id="startBtn">‚ñ∂ Start Assistant</button>

<div class="card">
<b>Heard</b>
<div id="heard" class="log">Waiting‚Ä¶</div>
</div>

<div class="card">
<b>Response</b>
<div id="response" class="log">---</div>
</div>

<div class="card">
<b>üìç Location</b>
<div id="loc" class="log">Inactive</div>
<div id="map"></div>
</div>

<div class="card">
<b>üé• Camera Feed</b>
<video id="cam" autoplay playsinline muted></video>
<canvas id="overlay"></canvas>
</div>
</div>

<!-- Face API -->
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<!-- Leaflet for map -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ===== GLOBALS ===== */
let rec, isVoiceActive=false;
let camStream=null, watchId=null;
let trustedFaceDetected=false;
let dictation=false;

const startBtn=document.getElementById("startBtn");
const heard=document.getElementById("heard");
const response=document.getElementById("response");
const loc=document.getElementById("loc");
const cam=document.getElementById("cam");
const overlay=document.getElementById("overlay");
const mapDiv=document.getElementById("map");

let map, marker;

/* ===== SPEECH ===== */
function speak(text){
  speechSynthesis.cancel();
  let msg=new SpeechSynthesisUtterance(text);
  msg.lang=navigator.language||"en-US";
  speechSynthesis.speak(msg);
  response.innerText=text;
}

/* ===== CAMERA ===== */
async function openCamera(){
  if(camStream) return;
  try{
    camStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"user"}});
    cam.srcObject = camStream;
    cam.style.display="block";
    overlay.width=cam.videoWidth;
    overlay.height=cam.videoHeight;
    speak("Camera on");
    detectFaceLoop();
  }catch(err){speak("Camera permission denied");}
}
function closeCamera(){
  if(!camStream) return;
  camStream.getTracks().forEach(t=>t.stop());
  camStream=null;
  cam.style.display="none";
  speak("Camera off");
}

/* ===== LOCATION ===== */
function initMap(lat=0,lng=0){
  map=L.map(mapDiv).setView([lat,lng],16);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19
  }).addTo(map);
  marker=L.marker([lat,lng]).addTo(map);
}
function updateLocation(pos){
  const lat=pos.coords.latitude;
  const lng=pos.coords.longitude;
  loc.innerHTML=`Lat: ${lat}<br>Lng: ${lng}<br>Accuracy: ${pos.coords.accuracy} m`;
  if(map && marker){marker.setLatLng([lat,lng]); map.setView([lat,lng]);}
}
function startTracking(){
  if(!navigator.geolocation){speak("Geolocation not supported"); return;}
  watchId=navigator.geolocation.watchPosition(updateLocation,err=>speak("Location error"),{enableHighAccuracy:true});
  speak("Location tracking started");
}
function stopTracking(){
  if(watchId){navigator.geolocation.clearWatch(watchId); watchId=null; loc.innerText="Location tracking stopped";}
  speak("Tracking stopped");
}

/* ===== EMERGENCY PHOTO ===== */
function takeEmergencyPhoto(){
  if(!camStream) return;
  const canvas=document.createElement("canvas");
  canvas.width=cam.videoWidth; canvas.height=cam.videoHeight;
  const ctx=canvas.getContext("2d");
  ctx.drawImage(cam,0,0,canvas.width,canvas.height);
  canvas.toBlob(blob=>{
    const link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download=`emergency_${Date.now()}.png`;
    link.click();
    speak("Emergency photo saved");
  });
}

/* ===== COMMAND HANDLER ===== */
function handle(cmd){
  heard.innerText=cmd;

  if(!trustedFaceDetected){speak("Face not recognized. Commands blocked."); return;}

  if(cmd.includes("emergency") || cmd.includes("help me")){
    takeEmergencyPhoto();
    speak("Emergency triggered. Photo captured.");
    return;
  }

  const commands={
    "start camera": openCamera,
    "stop camera": closeCamera,
    "start tracking": startTracking,
    "stop tracking": stopTracking,
    "dictation on": ()=>{dictation=true;speak("Dictation on")},
    "dictation off": ()=>{dictation=false;speak("Dictation off")},
    "status": ()=>speak("System running normally"),
    "what time": ()=>speak("The time is "+new Date().toLocaleTimeString()),
    "what date": ()=>speak("Today is "+new Date().toDateString())
  };
  for(let k in commands){if(cmd.includes(k)){commands[k](); return;}}
  speak("Command unclear");
}

/* ===== VOICE RECOGNITION ===== */
function startVoiceRecognition(){
  if(isVoiceActive) return;
  rec=new (window.SpeechRecognition||window.webkitSpeechRecognition)();
  rec.continuous=true; rec.interimResults=false;
  rec.lang=navigator.language||"en-US";
  rec.onresult=e=>{
    const cmd=e.results[e.results.length-1][0].transcript.toLowerCase().trim();
    handle(cmd);
  };
  rec.onerror=e=>speak("Voice recognition error");
  rec.start();
  isVoiceActive=true;
  speak("Voice assistant activated. Trusted face required for commands.");
}

/* ===== FACE RECOGNITION ===== */
let trustedFaceDescriptors=null;
async function loadFaceModels(){
  await faceapi.nets.tinyFaceDetector.loadFromUri("https://justadomain.github.io/models");
  await faceapi.nets.faceLandmark68Net.loadFromUri("https://justadomain.github.io/models");
  await faceapi.nets.faceRecognitionNet.loadFromUri("https://justadomain.github.io/models");
  speak("Face models loaded");
  // Load trusted faces here
  // Example placeholder:
  // trustedFaceDescriptors = [ new faceapi.LabeledFaceDescriptors("Honest",[descriptor]) ];
}
async function detectFaceLoop(){
  if(!camStream) return;
  const displaySize={width:cam.videoWidth,height:cam.videoHeight};
  faceapi.matchDimensions(overlay, displaySize);
  setInterval(async ()=>{
    const detections=await faceapi.detectAllFaces(cam,new faceapi.TinyFaceDetectorOptions())
      .withFaceLandmarks().withFaceDescriptors();
    const ctx=overlay.getContext("2d");
    ctx.clearRect(0,0,overlay.width,overlay.height);
    if(detections.length>0){
      const resizedDetections=faceapi.resizeResults(detections,displaySize);
      faceapi.draw.drawDetections(overlay,resizedDetections);
      faceapi.draw.drawFaceLandmarks(overlay,resizedDetections);
      if(trustedFaceDescriptors){
        const faceMatcher=new faceapi.FaceMatcher(trustedFaceDescriptors,0.5);
        detections.forEach(d=>{
          const bestMatch=faceMatcher.findBestMatch(d.descriptor);
          if(bestMatch.label!=="unknown"){trustedFaceDetected=true; speak("Trusted face detected"); }
        });
      } else {trustedFaceDetected=true;} // For testing without registered faces
    } else {trustedFaceDetected=false;}
  },200);
}

/* ===== START BUTTON ===== */
startBtn.addEventListener("click",async ()=>{
  try{await navigator.mediaDevices.getUserMedia({audio:true,video:true});}catch(e){speak("Camera/Mic permission denied"); return;}
  startVoiceRecognition();
  await loadFaceModels();
  openCamera();
  navigator.geolocation.getCurrentPosition(pos=>initMap(pos.coords.latitude,pos.coords.longitude));
});
</script>

</body>
</html>
